datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  SELLER
}

model User {
  id    Int    @id @default(autoincrement())
  name  String
  email String @unique

  password     String?
  authProvider String @default("LOCAL")

  googleId   String? @unique
  facebookId String? @unique

  role      Role     @default(SELLER)
  createdAt DateTime @default(now())

  sellerId Int?
  seller   Seller? @relation(fields: [sellerId], references: [id])

  passwordResets PasswordReset[]
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Seller {
  id           Int      @id @default(autoincrement())
  businessName String
  gstNumber    String?
  phone        String?
  createdAt    DateTime @default(now())

  users     User[]
  products  Product[]
  orders    Order[]
  uploads   Upload[]
  customers Customer[]
}

model Customer {
  id       Int     @id @default(autoincrement())
  sellerId Int
  name     String
  email    String?
  phone    String?

  totalOrders Int       @default(0)
  totalSpent  Float     @default(0)
  lastOrderAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller Seller @relation(fields: [sellerId], references: [id])
  orders Order[]

  @@unique([sellerId, email])
}

model Order {
  id Int @id @default(autoincrement())

  sellerId Int
  seller   Seller @relation(fields: [sellerId], references: [id])

  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])

  customerName    String
  customerPhone   String?
  customerEmail   String?
  shippingAddress String?

  subtotal    Float? @default(0)
  tax         Float? @default(0)
  totalAmount Float

  status        String @default("PENDING")
  paymentStatus String @default("UNPAID")
  paymentMethod String?

  trackingNumber String?
  timeline       Json?

  createdAt DateTime @default(now())

  products ProductOrder[]
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  category    String?
  price       Float
  stock       Int      @default(0)
  imageUrl    String?
  createdAt   DateTime @default(now())

  sellerId Int
  seller   Seller @relation(fields: [sellerId], references: [id])

  productOrders ProductOrder[]
}

model ProductOrder {
  id              Int @id @default(autoincrement())
  productId       Int
  orderId         Int
  quantity        Int
  priceAtPurchase Float?

  product Product @relation(fields: [productId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])
}

model Upload {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  seller    Seller   @relation(fields: [sellerId], references: [id])
  filename  String
  url       String
  createdAt DateTime @default(now())
}
