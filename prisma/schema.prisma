datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  SELLER
}

model User {
  id    Int    @id @default(autoincrement())
  name  String
  email String @unique

  password     String? // nullable for OAuth users
  authProvider String  @default("LOCAL")

  googleId   String? @unique
  facebookId String? @unique

  role      Role     @default(SELLER)
  createdAt DateTime @default(now())

  sellerId Int?
  seller   Seller? @relation(fields: [sellerId], references: [id])

  passwordResets PasswordReset[]
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Seller {
  id           Int      @id @default(autoincrement())
  businessName String
  gstNumber    String?
  phone        String?
  createdAt    DateTime @default(now())

  users    User[]
  products Product[]
  orders   Order[]
  uploads  Upload[]
  Customer Customer[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  category    String?
  price       Float
  stock       Int      @default(0)
  imageUrl    String?
  createdAt   DateTime @default(now())

  sellerId      Int
  Seller        Seller         @relation(fields: [sellerId], references: [id])
  productOrders ProductOrder[]
}

model Order {
  id              Int     @id @default(autoincrement())
  sellerId        Int
  customerId      Int

  customerName    String
  customerPhone   String?
  customerEmail   String?

  shippingAddress String?

  subtotal        Float? @default(0)
  tax             Float? @default(0)
  totalAmount     Float

  status          String  @default("PENDING")
  paymentStatus   String  @default("UNPAID")
  paymentMethod   String?

  trackingNumber  String?
  timeline        Json?

  createdAt       DateTime @default(now())

  Seller          Seller   @relation(fields: [sellerId], references: [id])
  customer        Customer @relation(fields: [customerId], references: [id])
  products        ProductOrder[]
}



model ProductOrder {
  id              Int    @id @default(autoincrement())
  productId       Int
  orderId         Int
  quantity        Int
  priceAtPurchase Float?

  Product Product @relation(fields: [productId], references: [id])
  Order   Order   @relation(fields: [orderId], references: [id])
}

model Upload {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  Seller    Seller   @relation(fields: [sellerId], references: [id])
  filename  String
  url       String
  createdAt DateTime @default(now())
}

model Customer {
  id       Int     @id @default(autoincrement())
  sellerId Int
  name     String
  email    String?
  phone    String?

  totalOrders Int       @default(0)
  totalSpent  Float     @default(0)
  lastOrderAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Seller Seller  @relation(fields: [sellerId], references: [id])
  orders Order[]

  @@unique([sellerId, email])
}
